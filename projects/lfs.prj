## Enable shared libraries (default) but disable static ones
BUILD_LIBSHARED=1
BUILD_LIBSTATIC=0

## Enable LTO both for kernel and applications
LTOENABLE=1
KERNEL_LTOENABLE=0

build lfs/create-base-fs_1.0
build lfs/create-base-config_1.0

mkdir -p ${USERDATA_PATH}/postinstall

setup_gcc --install

build raspberrypi/rpi-firmware_1
build firmwares/linux-firmware_20210511
build raspberrypi/rpi-kernel_5.15
build lfs/glibc_2.34
build lfs/tzdata_2021a
build lfs/man-pages_5.10
build lfs/iana-etc_20210202
build lfs/zlib_1.2.11
build lfs/bzip2_1.0.8
build lfs/xz_5.2.5
build lfs/zstd_1.4.8
build lfs/file_5.39
build lfs/readline_8.1
build lfs/bc_1.0.7
build lfs/gmp_6.2.1
build lfs/mpfr_4.1.0
build lfs/attr_2.4.48
build lfs/acl_2.2.53
build lfs/libcap_2.47
build lfs/shadow_4.8.1
build lfs/sed_4.8
build lfs/psmisc_23.3
build lfs/grep_3.6
build lfs/ncurses_6.2+p20210130
build lfs/bash_5.1+p4
build lfs/gdbm_1.19
build lfs/expat_2.2.10
build lfs/inetutils_2.0
build perl/XML::Parser_2.46
build lfs/perl_5.32.1
build lfs/intltool_0.51.0
build lfs/kmod_28
build lfs/elfutils_0.182
build lfs/libffi_3.3
build lfs/openssl_1.1.1i
build lfs/python_3.9.2 && setup_python
build lfs/coreutils_8.32
build lfs/diffutils_3.7
build lfs/gawk_5.1.0
build lfs/findutils_4.8.0
build lfs/groff_1.22.4
build lfs/less_563
build lfs/gzip_1.10
build lfs/iproute2_5.11.0
build lfs/kbd_2.4.0
build lfs/libpipeline_1.5.3
build lfs/man-db_2.9.3
build lfs/tar_1.33
build lfs/vim_8.2.2433
build lfs/systemd_247
build lfs/D-Bus_1.12.20
build lfs/procps-ng_3.3.16
build lfs/util-linux_2.36.2
build lfs/e2fsprogs_1.46
build lfs/btrfs-progs_5.10.1
build lfs/dosfstools_4.2
### Security
build lfs/sudo_1.9.5p2
build lfs/openssh_8.4p1
### System Utilities
build raspberrypi/pi-bluetooth
build lfs/bluez_5.55
build lfs/usb-utils_013
#build lfs/pciutils_5.7.0
build lfs/lsof_4.91
### Network
build lfs/dhcp_4.4.2
build firmwares/wireless-regdb_2021.08.28
build lfs/wpa_supplicant_2.9.0
build lfs/iw_5.9
build lfs/wireless-tools_29
build lfs/bind_9.16.12
build lfs/curl_7.75.0
### Development
build lfs/strace_5.10

### Final configurations ###
echo "arm_64bit=1" >${BIN_PATH}/boot/config.txt
echo "net.ifnames=0 console=tty1 root=/dev/mmcblk0p2 fsck.repair=yes rootwait" >${BIN_PATH}/boot/cmdline.txt

if [ ! -x ${LFS_HOSTNAME} ]
then
	echo Configuring Host Name
	echo ${LFS_HOSTNAME} > ${BIN_PATH}${BUILD_SYSCONFDIR}/hostname
fi
if [ ! -x ${WLAN_SSID} ] && [ ! -x ${WLAN_PSK} ] && [ ! -x ${WLAN_DEV} ]
then
	echo Configuring WiFi
	wpa_passphrase ${WLAN_SSID} ${WLAN_PSK} > ${BIN_PATH}${BUILD_SYSCONFDIR}/wpa_supplicant/wpa_supplicant-${WLAN_DEV}.conf
	systemctl --root=${BIN_PATH} enable wpa_supplicant@${WLAN_DEV}
	cat > ${BIN_PATH}/etc/systemd/network/${WLAN_DEV}.network <<-EOF
		[Match]
		Name=${WLAN_DEV}
		SSID=${WLAN_SSID}

		[Network]
		DHCP=yes
	EOF
	echo
fi
if [ x${ENABLE_SSH} != x ]
then
	echo Enabling SSHd
	ssh-keygen -A -f ${BIN_PATH}
	systemctl --root=${BIN_PATH} enable sshd
	echo
fi

echo "#!/bin/bash" >${BIN_PATH}/root/postinstall
echo "set -x" >>${BIN_PATH}/root/postinstall
find ${USERDATA_PATH}/postinstall -name "*.task" -exec cat {} >> ${BIN_PATH}/root/postinstall \;
echo "rm -f /root/postinstall" >> ${BIN_PATH}/root/postinstall
echo "set +x" >> ${BIN_PATH}/root/postinstall
chmod +x ${BIN_PATH}/root/postinstall
############################

function build_lfs_image () {
	create_image lfs --rootfstype btrfs --size 3MiB
	mount_tag lfs --mountlist "2:/ 1:/boot"
	inject_into_mount_tag lfs binaries --remove_devfiles
	run_on_root_dir lfs root "/root/postinstall"
	run_on_root_dir lfs root "useradd -G wheel -m lfs"
	run_on_root_dir lfs root "echo lfs:lfs | chpasswd"
	run_on_root_dir lfs root "pwconv"
	unmount_tag --finalize lfs
}

build_lfs_image

#create_sfx_archive remove_devfiles
#zip_project remove_devfiles