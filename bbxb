#!/bin/bash
trap 'STATUS=${?}; \
	set +x; \
	echo "ERR received. [bbxb: ${STATUS}]"; \
	echo; \
	pause; \
	check_images_functions; \
	set +o pipefail; \
	unmount_tag --all --kill || true; \
	trap - ERR SIGINT; \
	exit ${STATUS}' ERR
trap 'set +x; \
	echo "SIGINT received. [bbxb]"; \
	echo; \
	set +o pipefail; \
	unmount_tag --all --kill || true; \
	trap - ERR SIGINT; \
	exit 0' SIGINT

set -o pipefail

BB_HOME=$(dirname "$(realpath "${BASH_SOURCE[0]}")")
#PROGRAM_NAME="$(basename "${BASH_SOURCE[0]}")"

# shellcheck source=core.functions
source "${BB_HOME}/core.functions"
check_core_functions

OPTS="" OPTS_WITH_VALUE="" param2value "${@}"

PRJ_NAME="${_param_1}"
PLATFORM_NAME="${_param_2:-generic_x64}"

if [ -z "${PRJ_NAME}" ]
then
	echo "No project name specified!!!"
	exit 1
fi

# shellcheck source=setenv
source "${BB_HOME}/setenv"
# shellcheck source=build.functions
source "${BB_HOME}/build.functions"
# shellcheck source=project.functions
source "${BB_HOME}/project.functions"
# shellcheck source=toolchain.functions
source "${BB_HOME}/toolchain.functions"
# shellcheck source=images.functions
source "${BB_HOME}/images.functions"
# shellcheck source=/data.functions
source "${BB_HOME}/data.functions"

PRJ=${PRJ_PATH}/${PRJ_NAME}.prj
if [ ! -f "${PRJ}" ]
then
	echo "Project ${PRJ} does not exist."
	exit 1
fi

echo "Project path: ${DATA_PATH}/${PRJ_NAME}"
echo
# shellcheck source=projects/*
source "${PRJ}"
if check_images_functions
then
	unmount_tag --all
fi
trap - ERR SIGINT