#!/bin/bash
trap 'STATUS=${?}; \
	set +x; \
	echo "ERR received. [bbxb: ${STATUS}]"; \
	echo; \
	pause; \
	check_images_functions; \
	set +o pipefail; \
	unmount_tag --all --kill || true; \
	trap - ERR SIGINT; \
	exit ${STATUS}' ERR
trap 'set +x; \
	echo "SIGINT received. [bbxb]"; \
	trap - ERR SIGINT; \
	echo; \
	set +o pipefail; \
	check_images_functions && unmount_tag --all --kill || true; \
	exit 0' SIGINT

set -o pipefail

START_PWD=${PWD}
BB_HOME=$(dirname $(realpath ${BASH_SOURCE}))
PROGRAM_NAME=$(basename ${BASH_SOURCE})

. ${BB_HOME}/core.functions
check_core_functions

OPTS="" OPTS_WITH_VALUE="" param2value "${@}"
[ ${_param_v:-0} -eq 1 ] && set -x || true

PRJ_NAME=${_param_1}
PLATFORM_NAME=${_param_2:-generic_x64}

if [ -z "${PRJ_NAME}" ]
then
	echo "No project name specified!!!"
	exit 1
fi

. setenv
. ${BB_HOME}/build.functions
. ${BB_HOME}/project.functions
. ${BB_HOME}/toolchain.functions
. ${BB_HOME}/images.functions
. ${BB_HOME}/data.functions

PRJ=${PRJ_PATH}/${PRJ_NAME}.prj
if [ ! -f ${PRJ} ]
then
	echo "Project ${PRJ} does not exist."
	exit 1
fi

echo "Project path: ${DATA_PATH}/${PRJ_NAME}"
echo
source ${PRJ}
check_images_functions && unmount_tag --all || true
trap - ERR SIGINT