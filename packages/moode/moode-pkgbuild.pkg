# moode-pkgbuild
PKG_URL="https://github.com/moode-player/pkgbuild/archive/refs/heads/main.tar.gz"
BUILD_PROCESS=downloadonly
PKG_PREBUILD="
	mkdir -p ${PKG_PKGPATH}/usr/local/bin
	cp packages/runonce/runonce ${PKG_PKGPATH}/usr/local/bin/
	mkdir -p ${PKG_PKGPATH}/etc/systemd/system
	cp packages/runonce/run_once.service ${PKG_PKGPATH}/etc/systemd/system
	mkdir -p ${PKG_PKGPATH}/etc/runonce.d/ran
	mkdir -p ${PKG_PKGPATH}/postinst_scripts
	cp packages/moode-player/postinstall.sh ${PKG_PKGPATH}/postinst_scripts/99_moode_pkgbuild
	sed -i 's/systemctl st/# systemctl st/g' ${PKG_PKGPATH}/postinst_scripts/99_moode_pkgbuild
	sed -i 's#/usr/local/bin/moodeutl -r#mpd /etc/mpd.conf#' ${PKG_PKGPATH}/postinst_scripts/99_moode_pkgbuild
	cat <<-EOFM > ${PKG_PKGPATH}/postinst_scripts/99_moode_pkgbuild.starter
		mkdir -p /opt/alsaequal
		cat <<EOF | base64 -d > /opt/alsaequal/alsaequal.bin
			OAMAAO0GAAACAAAACgAAAAoAAAALAAAAAAAAAKCZmcCgmZnAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
			AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAKCZmcCgmZnAAAAAAAAA
			AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAA
			AKCZmcCgmZnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
			AAAAAAAAAAAAAAAAAwAAAKCZmcCgmZnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
			AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAKCZmcCgmZnAAAAAAAAAAAAAAAAAAAAAAAAA
			AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAKCZmcCgmZnAAAAA
			AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
			BgAAAKCZmcCgmZnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
			AAAAAAAAAAAAAAAAAAAABwAAAKCZmcCgmZnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
			AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAKCZmcCgmZnAAAAAAAAAAAAAAAAAAAAA
			AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQAAAKCZmcCgmZnA
			AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
			AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
			AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
		EOF
		chown mpd:audio /opt/alsaequal/alsaequal.bin
		cat <<EOF > /etc/mpd.conf
			#########################################
			# This file is automatically generated   
			# by the MPD configuration page.         
			#########################################

			music_directory \"/var/lib/mpd/music\"
			playlist_directory \"/var/lib/mpd/playlists\"
			db_file \"/var/lib/mpd/database\"
			log_file \"/var/log/mpd/log\"
			pid_file \"/var/run/mpd/pid\"
			state_file \"/var/lib/mpd/state\"
			sticker_file \"/var/lib/mpd/sticker.sql\"
			user \"mpd\"
			group \"audio\"
			bind_to_address \"any\"
			port \"6600\"
			log_level \"default\"
			restore_paused \"yes\"
			auto_update \"no\"
			follow_outside_symlinks \"yes\"
			follow_inside_symlinks \"yes\"
			zeroconf_enabled \"no\"
			zeroconf_name \"Moode MPD\"
			filesystem_charset \"UTF-8\"
			metadata_to_use \"+comment\"
			replaygain \"off\"
			replaygain_preamp \"0\"
			volume_normalization \"no\"
			audio_buffer_size \"4096\"
			max_output_buffer_size \"131072\"
			max_playlist_length \"16384\"
			max_connections \"128\"

			decoder {
			plugin \"ffmpeg\"
			enabled \"yes\"
			}

			input {
			plugin \"curl\"
			}

			resampler {
			plugin \"soxr\"
			quality \"high\"
			threads \"1\"
			}

			audio_output {
			type \"alsa\"
			name \"ALSA Default\"
			device \"_audioout\"
			mixer_type \"hardware\"
			mixer_control \"Invalid card number '0'.\"
			mixer_device \"hw:0\"
			mixer_index \"0\"
			dop \"no\"
			stop_dsd_silence \"no\"
			thesycon_dsd_workaround \"no\"
			}

			audio_output {
			type \"alsa\"
			name \"ALSA Bluetooth\"
			device \"_audioout\"
			mixer_type \"software\"
			}

			audio_output {
			type \"httpd\"
			name \"HTTP Server\"
			port \"8000\"
			encoder \"lame\"
			bitrate \"320\"
			tags \"yes\"
			always_on \"yes\"
			}
		EOF
		bash -x /postinst_scripts/99_moode_pkgbuild configure
		mpd --kill
		rm -f /etc/mpd.conf
	EOFM
	"
