# moode-r50
PKG_URL="https://github.com/moode-player/moode/archive/r50prod.tar.gz"
PKG_SRCDIR=moode-r50
PATCHES="rotenc-makefile.patch"
BUILD_PROCESS=downloadonly
PKG_PREBUILD="install -D boot/config.txt.default ${BIN_PATH}/boot/config.txt
install -d ${BIN_PATH}/etc/sudoers.d
echo -e 'www-data\tALL=(ALL) NOPASSWD: ALL' >> ${BIN_PATH}/etc/sudoers.d/010_www-data
# Dirs
install -m 0755 -d ${BIN_PATH}/var/local/www
install -m 0755 -d ${BIN_PATH}/var/local/www/commandw
install -m 0755 -d ${BIN_PATH}/var/local/www/imagesw
install -m 0755 -d ${BIN_PATH}/var/local/www/imagesw/toggle
install -m 0755 -d ${BIN_PATH}/var/local/www/db
install -d ${BIN_PATH}/var/lib/mpd/music/RADIO
# Mount points
install -d ${BIN_PATH}/mnt/NAS
install -d ${BIN_PATH}/mnt/SDCARD
# Symlinks
ln -fs /mnt/NAS ${BIN_PATH}/var/lib/mpd/music/NAS
ln -fs /mnt/SDCARD ${BIN_PATH}/var/lib/mpd/music/SDCARD
ln -fs /media ${BIN_PATH}/var/lib/mpd/music/USB
# Logs
install -D -m 0666 /dev/null ${BIN_PATH}/var/log/moode.log
install -D -m 0666 /dev/null ${BIN_PATH}/var/log/php_errors.log
# Files
install -D mpd/sticker.sql ${BIN_PATH}/var/lib/mpd
install -d ${BIN_PATH}/mnt/SDCARD
install -D other/sdcard/Stereo\ Test/* ${BIN_PATH}/mnt/SDCARD/
install -D network/interfaces.default ${BIN_PATH}/etc/network/interfaces
install -D network/wpa_supplicant.conf.default ${BIN_PATH}/etc/wpa_supplicant/wpa_supplicant.conf
install -D network/dhcpcd.conf.default ${BIN_PATH}/etc/dhcpcd.conf
install -D network/hostapd.conf.default ${BIN_PATH}/etc/hostapd/hostapd.conf
install -D var/local/www/db/moode-sqlite3.db.default ${BIN_PATH}/var/local/www/db/moode-sqlite3.db
# Moode sources and configs
install -D mpd/RADIO/* ${BIN_PATH}/var/lib/mpd/music/RADIO
install -D mpd/playlists/* ${BIN_PATH}/var/lib/mpd/playlists/
install -D -m 0644 etc/* ${BIN_PATH}/etc
install -d ${BIN_PATH}/etc/avahi/services
install -D -m 0644 etc/avahi/services/* ${BIN_PATH}/etc/avahi/services/
install -d ${BIN_PATH}/etc/bluetooth
install -D -m 0644 etc/bluetooth/* ${BIN_PATH}/etc/bluetooth/
install -d ${BIN_PATH}/etc/dbus-1/system.d
install -D -m 0644 etc/dbus-1/system.d/* ${BIN_PATH}/etc/dbus-1/system.d/
install -d ${BIN_PATH}/etc/default
install -D -m 0644 etc/default/* ${BIN_PATH}/etc/default/
install -d ${BIN_PATH}/etc/init.d
install -D -m 0755 etc/init.d/* ${BIN_PATH}/etc/init.d/
install -d ${BIN_PATH}/etc/modprobe.d
install -D -m 0644 etc/modprobe.d/* ${BIN_PATH}/etc/modprobe.d/
install -d ${BIN_PATH}/etc/nginx
install -D -m 0644 etc/nginx/* ${BIN_PATH}/etc/nginx/
install -d ${BIN_PATH}/etc/pam.d
install -D -m 0644 etc/pam.d/* ${BIN_PATH}/etc/pam.d/
cp -r etc/php ${BIN_PATH}/etc/
install -d ${BIN_PATH}/etc/samba
install -D -m 0644 etc/samba/* ${BIN_PATH}/etc/samba/
install -d ${BIN_PATH}/etc/systemd/system
install -D -m 0644 etc/systemd/system/* ${BIN_PATH}/etc/systemd/system/
install -d ${BIN_PATH}/etc/udev/rules.d
install -D -m 0644 etc/udev/rules.d/* ${BIN_PATH}/etc/udev/rules.d/
install -d ${BIN_PATH}/etc/update-motd.d
install -D -m 0644 etc/update-motd.d/* ${BIN_PATH}/etc/update-motd.d/
install -d ${BIN_PATH}/home/pi
install -D -m 0755 home/*.sh ${BIN_PATH}/home/pi
install -D -m 0755 home/*.php ${BIN_PATH}/home/pi
install -D -m 0644 home/dircolors ${BIN_PATH}/home/pi/.dircolors
install -D -m 0644 home/xinitrc.default ${BIN_PATH}/home/pi/.xinitrc
install -d ${BIN_PATH}/lib/systemd/system
install -D -m 0644 lib/systemd/system/* ${BIN_PATH}/lib/systemd/system/
install -d ${BIN_PATH}/usr/local/bin
install -D -m 0755 usr/local/bin/* ${BIN_PATH}/usr/local/bin/
#install -d ${BIN_PATH}/usr/local/etc
install -D -m 0644 usr/local/etc/shairport-sync.conf ${BIN_PATH}/etc/
install -d ${BIN_PATH}/usr/lib/tmpfiles.d
install -D -m 0644 usr/lib/tmpfiles.d/* ${BIN_PATH}/usr/lib/tmpfiles.d/
install -d ${BIN_PATH}/usr/share
cp -r usr/share/* ${BIN_PATH}/usr/share/
install -d ${BIN_PATH}/var/local
cp -r var/local/www ${BIN_PATH}/var/local/
cp -r www ${BIN_PATH}/var/
chmod 0755 ${BIN_PATH}/var/www/command/*
# Bluetooth
chmod 0666 ${BIN_PATH}/etc/bluealsaaplay.conf
chmod 0755 ${BIN_PATH}/usr/local/bin/a2dp-autoconnect
# Localui
chmod -R 0755 ${BIN_PATH}/var/local/www
chmod -R 0777 ${BIN_PATH}/var/local/www/db
chmod -R ug-s ${BIN_PATH}/var/local/www
#chmod 0777 ${BIN_PATH}/var/local/www/playhistory.log
chmod 0777 ${BIN_PATH}/var/local/www/currentsong.txt
install -D -m 0777 /dev/null ${BIN_PATH}/var/local/www/libcache.json
echo 'BUFFERTIME=20000' >> ${BIN_PATH}/etc/bluealsaaplay.conf
sed -i 's|bluealsa-aplay --profile-a2dp|bluealsa-aplay --pcm-buffer-time=${BUFFERTIME} --profile-a2dp|g' ${BIN_PATH}/etc/systemd/system/bluealsa-aplay@.service
# Permissions
chmod 0777 ${BIN_PATH}/var/lib/mpd/music/RADIO
chmod -R 0777 ${BIN_PATH}/var/local/www/db
# Deletes
# Final prep for image
install -D -m 0644 network/interfaces.default ${BIN_PATH}/etc/network/interfaces
## NOTE: if you created a wpa_supplicant.conf file back in STEP 1 to run the
## build over a WiFi connection then don't copy the wpa_supplicant.conf file. 
install -D -m 0644 network/wpa_supplicant.conf.default ${BIN_PATH}/etc/wpa_supplicant/wpa_supplicant.conf
install -D -m 0644 network/dhcpcd.conf.default ${BIN_PATH}/etc/dhcpcd.conf
install -D -m 0644 network/hostapd.conf.default ${BIN_PATH}/etc/hostapd/hostapd.conf"