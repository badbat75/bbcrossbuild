# systemd
PKG_VER=252.2
PKG_URL="https://github.com/systemd/systemd-stable/archive/refs/tags/v${PKG_VER}.tar.gz"
#PATCHES="https://www.linuxfromscratch.org/patches/lfs/development/systemd-251-glibc_2.36_fix-1.patch"
PKG_DEPS="lfs/libxcrypt \
	lfs/zlib_1 lfs/xz_5.2.5 lfs/bzip2_1.0.8 lfs/zstd_1.5.2 lfs/lz4_1.9 \
	lfs/libxslt_1.1.36 lfs/libxml2_2.10 lfs/libcap_2.47"
BUILD_PROCESS=mesonninja
CONF_FLAGS="-Drootlibdir=${BUILD_LIBDIR}${BUILD_LIBSUFFIX}"
CONF_FLAGS+=" -Ddefault-dnssec=no"
CONF_FLAGS+=" -Dfirstboot=false"
CONF_FLAGS+=" -Dinstall-tests=false"
CONF_FLAGS+=" -Dldconfig=false"
CONF_FLAGS+=" -Dsysusers=false"
CONF_FLAGS+=" -Drpmmacrosdir=no"
CONF_FLAGS+=" -Dhomed=false"
CONF_FLAGS+=" -Duserdb=false"
CONF_FLAGS+=" -Dmode=release"
PKG_TARGET=${PKG_TARGET:-${SYSTEMD_TARGET}}
case "${PKG_TARGET}" in
	bootstrap) LIBAUDIT_TARGET=bootstrap ;;
	*)
		PKG_DEPS+=" lfs/libgcrypt_1.10 lfs/openssl_3 \
			lfs/Linux-PAM lfs/polkit lfs/elfutils_0 lfs/GLib \
			lfs/libidn2_2.3 lfs/libseccomp_2.5 lfs/make-ca_1 \
			lfs/p11-kit_0.24.1 lfs/pcre2_10.40 lfs/kmod_30 \
			lfs/util-linux_2.38.1 lfs/curl_7"
		CONF_FLAGS+=" -Dblkid=true"
		CONF_FLAGS+=" -Dman=auto"
		CONF_FLAGS+=" -Dpam=true"
		CONF_FLAGS+=" -Dpamlibdir=${BUILD_LIBDIR}/security"
		CONF_FLAGS+=" -Dpamconfdir=/etc/pam.d"
		if [ ${ENABLE_DBUS:-1} -eq 1 ]
		then
			PKG_DEPS+=" lfs/D-Bus"
			CONF_FLAGS+=" -Ddbussystemservicedir=${BUILD_PREFIX}/share/dbus-1/system-services"
			CONF_FLAGS+=" -Ddbussessionservicedir=${BUILD_PREFIX}/share/dbus-1/services"
			CONF_FLAGS+=" -Ddbuspolicydir=${BUILD_PREFIX}/share/dbus-1/system.d"
		fi
		PKG_POSTBUILD="install -v -m755 -d ${PKG_PKGPATH}/etc/pam.d
			cat >> ${PKG_PKGPATH}/etc/pam.d/system-session <<-EOF
				# Begin Systemd addition

				session  required    pam_unix.so
				session  required    pam_loginuid.so
				session  optional    pam_systemd.so

				# End Systemd addition
			EOF

			cat > ${PKG_PKGPATH}/etc/pam.d/systemd-user <<-EOF
				# Begin /etc/pam.d/systemd-user

				account  required    pam_access.so
				account  include     system-account

				session  required    pam_env.so
				session  required    pam_limits.so
				session  required    pam_unix.so
				session  required    pam_loginuid.so
				session  optional    pam_keyinit.so force revoke
				session  optional    pam_systemd.so

				auth     required    pam_deny.so
				password required    pam_deny.so

				# End /etc/pam.d/systemd-user
			EOF
			"
		PKG_POSTINSTALL="systemd-machine-id-setup; systemctl preset-all; systemctl disable systemd-sysupdate{,-reboot}"
		PKG_POSTINSTALL_PRIO=10
	;;
esac
INST_CMD="install"
PKG_LD_LIBRARY_PATH=${SYSROOT}${BUILD_LIBDIR}${BUILD_LIBSUFFIX}
PKG_PREBUILD="sed -i -e 's/GROUP=\"render\"/GROUP=\"video\"/' -e 's/GROUP=\"sgx\", //' rules.d/50-udev-default.rules.in"
### Python modules does not pass sysroot flags...
PKG_FAULTYCFLAGS=1